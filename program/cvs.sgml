<!-- $Id$ -->
<chapter id="version">
<title>Versioner af software</title>

<para>
I dette kapitel vil vi se nærmere på kontrol af forskellige versioner
af software. Når der er hastig Open Source programudvikling, så vil
der findes forskellige versioner af en fil, som programmøren skal
kunne sammenligne, flette sammen og finde forskelligheder.
</para>



<sect1 id="diff">
<title>diff og patch</title>
<indexterm><primary>diff</primary></indexterm>
<indexterm><primary>forskelle mellem filer, finde</primary></indexterm>
<para>
Ofte vil programmøren skulle se hvad der er ændret mellem to versioner
af en fil. Er der måske 2000 linier kode er dette ofte umuligt at gøre
manuelt, og derfor bør du se nærmere på et par værktøjer, der kan
hjælpe dig meget. Lad os tage et eksempel på hvordan dette gøres:
</para>

<example id="ex-diff">
<title>Anvendelse af diff</title>

<para>
Først ser vi på en program-stump, vi kan kalde <filename>A_org.c</filename>.
</para>

<programlisting>
typedef struct {
  unsigned int R;
  unsigned int G;
  unsigned int B;
} RGB_Image;

typedef struct {
  int *m,*n;
  int No;
} pixar;
</programlisting>

<para>
Denne skal vi sammenligne med <filename>A.c</filename>, der ser
således ud:
</para>

<programlisting>
typedef struct {
  unsigned int R;
  unsigned int G;
  unsigned int B;
} RGB_Image;

typedef struct {
  int *m,*p;
  int No;
} pixar;

int a,b,c;
</programlisting>

<para>
De ser jo meget ens ud, de to stumper kode. For at se forskelle kører vi
</para>

<screen>
<prompt>[anne@linus ~]$  </prompt><userinput>diff A_org.c A.c</userinput>
8c8
&lt;   int *m,*n;
---
&gt;   int *m,*p;       
10a11,13
&gt;
&gt; int a,b,c;
</screen>

<para>
Vi kan se at linie 8 er ændret (8c8 betyder at linie 8 i
<filename>A_org.c</filename>er ændret i forhold til linie 8 i
<filename>A.c</filename>). Næste information (10a11,13) er at linie 11
til 13 i <filename>A.c</filename> er appended, dvs. tilføjet, i
forhold til linie 10 i <filename>A_org.c</filename>.
</para>

<para>
En lille huske-regel mht. &gt; og &lt;, så er &lt; filen til venste i
argumentlisten til <command>diff</command> og tilsvarende er &gt; filen
til højre (2. argument).
</para>

<para>
Det skal også nævnes, at man ofte laver en "unified diff", med
</para>

<screen>
<prompt>[anne@linus ~]$  </prompt><userinput>diff -u A_org.c A.c</userinput>
--- A_org.c     Tue Dec 19 21:56:30 2000
+++ A.c Tue Dec 19 21:56:43 2000
@@ -5,6 +5,8 @@
 } RGB_Image;
 
 typedef struct {
-  int *m,*n;
+  int *m,*p;
   int No;
 } pixar;
+
+int a,b,c;      
</screen>

<para>
Her er samme information gemt, men med en anden syntaks. Med - og +
vises hvilke linier som er ændret men også et par af de foregående og
efterfølgende linier kommer også med. Det gør det lidt nemmere at
finde stedet for ændringer efterfølgende.
</para>
</example>

<para>
<indexterm><primary>patches</primary></indexterm>
Ofte er der kun små ændringer mellem to versioner af en fil, og derfor
ses det ofte, at man distribuerer kildekode til en basisversion og
derefter en eller flere "patches" til programmet, som er filer som
dannes ved at køre diff mellem basisversionen og den nye version af
filen. Lad os se dette i et eksempel.
</para>

<example id="ex-patch">
<title>Anvendelse af patch</title>

<para>
Normalt anvendes patches til at sende
ændringer/opdateringer fra programmøren til andre der programmerer på samme
fil(er). Derfor er filnavne 
<filename>A_org.c</filename> og <filename>A.c</filename>, som var
anvendt i eksemplet ovenfor normalt anvendt som den originale fil i
forhold til den nye. Ofte har programmøren to fil-strukturer liggende
- den originale og den nye med ændringer.
</para>

<para>
Først lader vi programmøren af programmet danne en patch mellem
filerne <filename>A_org.c</filename> og <filename>A.c</filename>, hvor
de to filer er nævnt ovenfor:
</para>

<screen>
<prompt>[anne@linus ~]$  </prompt><userinput>diff -u A_org.c A.c &gt; A_patch</userinput>
</screen>

<para>
Bemærk at jeg her vender de to filer, som den nye er sidst!
</para>

<para>
Nu kan programmøreren sende patch-filen <filename>A_patch</filename>
til andre programmører, som kan opdatere deres
<filename>A.c</filename>.  Lad os prøve dette. Vi antager nu, at vi er
brugeren "tyge", som har en fil <filename>A.c</filename>, som er lig med
programmørens fil <filename>A_org.c</filename>
</para>

<screen>
<prompt>[tyge@linus ~]$  </prompt><userinput>patch < A_patch</userinput>
patching file A.c  
</screen>

<para>
Så nemt er det at opgrade til den opdaterede version. Ofte kan en
patch-fil indeholde rettelser til mange filer, som så automatisk opdateres.
</para>
</example>
</sect1>

<sect1 id="emacs-diff">
<title>Emacs og forskellige versioner af filer</title>
<indexterm>
 <primary>Emacs</primary>
 <secondary>forskellige versioner af filer</secondary>
</indexterm>

<para>
Som programmør (eller
skribent af Linux-bøger), sker det ofte at en person sender en ny og
opdateret version af en eller flere filer og det er så programmøren,
der skal læse rettelserne igennem og vurdere hvilke, som skal
accepteres til næste udgivelse af kildekoden.
</para>

<para>
Hvis man skal sammenligne forskellige versioner af filer, så er
tekst-editoren <command>emacs</command> eller
<command>xemacs</command> et program som virkelig er godt. Det er bare
svært at forstå som en nybegynder. Men hæng i - det betaler sig. Lad
os tage et eksempel. Start <command>emacs A_org.c A.c</command> - som
er de to filer, som blev vist ovenfor. Resultatet er vist på 
<xref linkend="emacsdiff-fig">.
</para>

<para>
Vælg nu menuen <command>Tools-&gt;Compare-&gt;Two Buffers...</command>
og accepter at buffer A er <filename>A_org.c</filename> og buffer B er
<filename>A.c</filename>. Der kommer nu en lille menu-boks frem. Prøv
at trykke <command>?</command> i denne (før musen hen til boksen -
tryk venstre mus, hvis boksen ikke er valgt - derefter
<command>?</command>). Her er alle kommandoer man kan anvende - se
dette på <xref linkend="emacsdiff2-fig">. Tryk <command>?</command>
igen for at komme tilbage til den lille ramme.  Vi skal nu blive her i
den lille ramme og kun anvende det store emacs-vindue til at se hvad
der sker.
</para>

<FIGURE ID="emacsdiff-fig" FLOAT="1">
<TITLE>Emacs med to filer indlæst</TITLE>
<GRAPHIC FILEREF="emacsdiff.&magic;"  SCALE="60"></GRAPHIC>
</FIGURE>

<FIGURE ID="emacsdiff2-fig" FLOAT="1">
<TITLE>Emacs diff kommandoer</TITLE>
<GRAPHIC FILEREF="emacsdiff2.&magic;"  SCALE="60"></GRAPHIC>
</FIGURE>

<para>
Lad os komme igang med at se hvordan vores
<filename>A_org.c</filename> kan opdateres med rettelserne i
<filename>A.c</filename>. Tryk <command>n</command> for at gå til
første rettelse. Som det kan ses på <xref linkend="emacsdiff3-fig">,
så er der et "n" fra <filename>A_org.c</filename> som er ændret til 
et "p" i <filename>A.c</filename>. Hvis man nu vil acceptere denne
rettelse og føre den fra <filename>A.c</filename> til
<filename>A_org.c</filename> så trykker vi "<command>b</command>" for at
føre rettelsen fra buffer B til buffer A. (Modsat så anvendes
"<command>a</command>" for at kopiere fra A til B). Tryk
"<command>n</command>" for næste rettelse og "<command>p</command>" for
forrige (previous). Man kan også trykke "<command>!</command>" løbende
for at opdatere tælleren i den lille boks med antal forskelle. Skriv
til sidst "<command>q</command>" for at slutte denne
sammenlignings-session. Svar dernæst "<command>y</command>" i bunden
af det store Emacs vindue. Gem filerne passende og du er færdig.
</para>

<FIGURE ID="emacsdiff3-fig" FLOAT="1">
<TITLE>Emacs viser første rettelse</TITLE>
<GRAPHIC FILEREF="emacsdiff3.&magic;"  SCALE="60"></GRAPHIC>
</FIGURE>
</sect1>

<sect1 id="xxdiff">
<title>xxdiff</title>

<para>
Hvis man ikke bruger emacs, kan man få samme funktionalitet ved at at bruge
programmet <command>xxdiff</command>	<ulink url="http://xxdiff.sourceforge.net/">http://xxdiff.sourceforge.net/</ulink>.
</para>

<para>
Programmet startes med <command>xxdiff A_org.c A.c</command>.
</para>

<FIGURE ID="xxdiff1-fig" FLOAT="1">
<TITLE>xxdiff med to filer indlæst</TITLE>
<GRAPHIC FILEREF="xxdiff1.&magic;"  SCALE="60"></GRAPHIC>
</FIGURE>


<para>
For at gå til den første forskel trykkes <command>"n"</command>.
Hvis man vil bruge udgaven til venstre trykker man 
<command>"h"</command>, og hvis man vil bruge den til højre trykker
man <command>"k"</command>. Bemærk at man har en grafisk oversigt
over sine valg i hele filen ude i højre margen.
</para>

<FIGURE ID="xxdiff2-fig" FLOAT="1">
<TITLE>Den venstre version er valgt ved første forskel</TITLE>
<GRAPHIC FILEREF="xxdiff2.&magic;"  SCALE="60"></GRAPHIC>
</FIGURE>

<para>
For at komme til næste forskel trykkes <command>"n"</command>, og
for den forrige <command>"p"</command>.
</para>

<para>
Når man er færdig med at vælge, skal man huske at gemme filen.
</para>
</sect1>


<sect1 id="Revisionskontrolsystemer">
<title>Revisionskontrolsystemer</title>
<indexterm><primary>Revisionskontrolsystemer</primary></indexterm>
<indexterm><primary>CVS</primary></indexterm>
<indexterm><primary>Versionsstyring</primary></indexterm>
<para>
Hvad, der burde være i en separat kategori, er revisionskontrol eller
versionsstyring. Til Linux kan det anbefales at anvende CVS, der står
for "Concurrent Version System". Med CVS kan du styre projekter, som
flere personer arbejder sammen om (også selvom de arbejder på hver sin
maskine), og alle kan nemt se, hvad andre har opdateret til en fælles
database, som kan ligge på en helt anden UNIX-server. Det er meget
smart og forbløffende enkelt at arbejde med i det daglige, hvis man
sætter sig ind i det.
</para>

<para>
Hvis du i Emacs indlæser en fil, der er koblet ind i CVS, vil Emacs
automatisk genkende dette og indsætte en ekstra menu, hvorfra du
på enkel vis kan sende tilføjelser til den fælles database (selve
ændringerne skal du ikke selv styre - det klarer Emacs og CVS).
</para>

<para>
I tilfælde af indsættelse af fejlbehæftet kode i CVS kan du på et
vilkårligt tidspunkt gå baglæns i revisionerne og få tidligere kode
ud. Problemer med, at folk retter i samme del af koden kan enten nemt
forhindres (ved at filer, man retter i, låses for andre), eller man kan
bare kode løs - det er nemt at flette kode, og problemer med overlap
mellem egne og andres kodeændringer vil tydeligt blive vist for
brugeren.
</para>

<para>
CVS er gratis og meget nemt at anvende. Der kan læses mere
om CVS på f.eks. 
<ulink url="http://www.sourcegear.com/CVS">http://www.sourcegear.com/CVS</ulink>, 
<ulink url="http://www.sslug.dk/artikler/CVS.html">http://www.sslug.dk/artikler/CVS.html</ulink>
og  f.eks. i den bog i postscript-format, der findes om CVS på <ulink
url="http://www.sslug.dk/artikler">http://www.sslug.dk/artikler</ulink>.
</para>

<para>
Se også <ulink url="http://cvs.sslug.dk/cvs2html">http://cvs.sslug.dk/cvs2html</ulink>
for CVS-hjælpeprogrammer.
</para>

</sect1>
</chapter>
