#!/bin/bash

# Dette script bootstrapper/konfigurer det der skal til for at lave linuxbøgerne 

# Af Mads Bondo Dydensborg, madsdyd@challenge.dk, september 2003.

# Standard bøger at medtage
#SUBDIRS="admin applikationer c dokumentation forsker friheden itplatform java kontorbruger program signatur sikkerhed unix web wm"
SUBDIRS="itplatform friheden unix kontorbruger applikationer wm signatur admin sikkerhed program web c java dokumentation forsker"
ALLE=
URL=cvs.linuxbog.dk


################################################################################
#
# Brug
brug() {
    echo "Brug: ./configure [OPTIONS] [-- SUBDIROPTIONS]"
    echo
    echo "Hvor OPTIONS kan være een eller flere af "
    echo "  -h, --help             Viser denne hjælp og afslutter"
    echo "  -m, --med \"BØGER\"      Bestemmer hvilke bøger der medtages, hvor BØGER"
    echo "                         er en liste af bøger. Kombiner:"
    echo "                         \"$SUBDIRS\""
    echo "  -a, --med-alle         Medtag alle (een stor bog) bogen"
    echo "  -u, --bogurl URL       Hvilken url bøgerne skal bruge. [cvs.linuxbog.dk]"
    echo
    echo "Hvor SUBDIROPTIONS kan være"
    echo "      --enable-softlink  Bruger softlinks for HTML targets"
    echo "Eksempel: ./configure --med \"friheden applikationer\" -- --enable-softlink";
}

################################################################################
#
# hjaelp
hjaelp() {
    echo "\`configure' opsætter hvilke af \"Linux - friheden til at vælge bøgerne\" der skal"
    echo "laves på dit system."
    echo
    brug
    exit
}


################################################################################
#
# Check for argumenter

# Originale argumenter gemmes til Makefile
ORG_ARGS=
for arg ; do ORG_ARGS="$ORG_ARGS \"$arg\"" ; done

# Note that we use `"$@"' to let each command-line parameter expand to a
# separate word. The quotes around `$@' are essential!
# We need TEMP as the `eval set --' would nuke the return value of getopt.
TEMP=`getopt -o ahm:u: --long med-alle,help,med:,bogurl: -n "$0" -- "$@"`

if [ $? != 0 ] ; then brug ; exit 1 ; fi

# Note the quotes around `$TEMP': they are essential!
eval set -- "$TEMP"

while true ; do
    case "$1" in
	-a|--med-alle) ALLE=alle ; shift ;;
	-h|--help) hjaelp; shift ;;
	-m|--med) SUBDIRS=$2 ; shift 2 ;;
	-u|--bogurl) URL=$2 ; shift 2 ;;
	--) shift ; break ;;
	*) echo "Internal error!" ; exit 1 ;;
    esac
done

# Opsaml ekstra argumenter til bøger
EXTRA_ARG=
for arg ; do EXTRA_ARG="$EXTRA_ARG $arg" ; done
#echo "EXTRA_ARG: $EXTRA_ARG"

################################################################################
#
# Check at Makefile.in findes. 
if test ! -e Makefile.in ; then
    echo "Fejl: Kunne ikke finde Makefile.in"
    echo "Vær venlig at køre dette script fra roden af Linux bøgernes kildetekst"
    exit 2;
fi


################################################################################
#
# Rent faktisk gøre noget.

# Status til bruger
echo "*** Opsætter følgende bøger: $SUBDIRS"
if test "x$ALLE" != "x" ; then
  echo "*** Opsætter alle bogen"
else
  echo "*** Opsætter ikke alle bogen"
fi

# Lav Makefile
sed -e "s/@SUBDIRS@/$SUBDIRS/" \
    -e "s/@ALLE@/$ALLE/" \
    -e "s/@CONFIGUREARGS@/$ORG_ARGS/" \
    -e "s/@Makefile.in@/RET IKKE I DENNE FIL - AUTOGENERERET FRA Makefile.in/" \
    < Makefile.in > Makefile

# Faelles filer
for dir in $SUBDIRS ; do
    echo "*** Installerer fælles filer i $dir"
    cp --update faelles-filer/*.css $dir
    cp --update faelles-filer/*.sgml $dir
    echo "<!ENTITY linuxbogurl \"$URL\">" > $dir/linuxbogurl.sgml || exit;
done
if test "x$ALLE" != "x" ; then
    echo "*** Installerer fælles filer i $ALLE"
    cp --update faelles-filer/*.sgml $ALLE
    echo "<!ENTITY linuxbogurl \"$URL\">" > $ALLE/linuxbogurl.sgml || exit;
fi

# Byggerelaterede filer
for dir in $SUBDIRS; do
    echo "*** Kører bootstrap i $dir"
    cp --update bootstrap.subdir $dir/bootstrap
    cp --update Makefile.subdir $dir/Makefile.am
    cp --update configure.ac.subdir $dir/configure.ac
    cp --update linuxbog.spec $dir/linuxbog.spec
    mkdir -p $dir/misc
    cp --update misc/insertimagesize $dir/misc/
    cd $dir && ./bootstrap && cd .. || exit ;
done
if test "x$ALLE" != "x" ; then
    echo "*** Kører bootstrap i $ALLE"
    cp --update bootstrap.subdir $ALLE/bootstrap
    sed "s/@SUBDIRSALLE@/$SUBDIRS/" < Makefile.alle > $ALLE/Makefile.am
    cp --update configure.ac.subdir $ALLE/configure.ac
    cp --update linuxbog.spec $ALLE/linuxbog.spec
    mkdir -p $ALLE/misc
    cp --update misc/insertimagesize $ALLE/misc/
    cd $ALLE && ./bootstrap && cd .. || exit ;
    cd $ALLE &&	./make.bog.sgml.pl $SUBDIRS > bog.sgml && cd .. || exit ;
fi

# Så køres ./configure i hvert subdir. 
for dir in $SUBDIRS; do
    echo "*** Kører configure i $dir"
    cd $dir && ./configure $EXTRA_ARG && cd .. || exit ;
done
if test "x$ALLE" != "x" ; then
    echo "*** Kører configure i $ALLE"
    cd $ALLE && ./configure $EXTRA_ARG && cd .. || exit ;
fi

echo "*** Du kan nu køre f.eks. make all, eller make dist"
